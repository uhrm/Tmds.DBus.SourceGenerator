using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.CSharp.Syntax;

using static Microsoft.CodeAnalysis.CSharp.SyntaxFactory;


namespace Tmds.DBus.SourceGenerator
{
    public partial class DBusSourceGenerator
    {
        private static MethodDeclarationSyntax MakeWriteNullableStringMethod() =>
            MethodDeclaration(
                    PredefinedType(Token(SyntaxKind.VoidKeyword)),
                    "WriteNullableString")
                .AddModifiers(
                    Token(SyntaxKind.PublicKeyword),
                    Token(SyntaxKind.StaticKeyword))
                .AddParameterListParameters(
                    Parameter(
                            Identifier("writer"))
                        .WithType(
                            IdentifierName("Tmds.DBus.Protocol.MessageWriter"))
                        .AddModifiers(
                            Token(SyntaxKind.ThisKeyword),
                            Token(SyntaxKind.RefKeyword)),
                    Parameter(
                            Identifier("value"))
                        .WithType(
                            NullableType(
                                PredefinedType(Token(SyntaxKind.StringKeyword)))))
                .WithExpressionBody(
                    ArrowExpressionClause(
                        InvocationExpression(
                        MakeMemberAccessExpression("writer", "WriteString"))
                            .AddArgumentListArguments(
                                Argument(
                                    BinaryExpression(
                                        SyntaxKind.CoalesceExpression,
                                        IdentifierName("value"),
                                        MakeMemberAccessExpression("string", "Empty"))))))
                .WithSemicolonToken(Token(SyntaxKind.SemicolonToken));

        private static MethodDeclarationSyntax MakeWriteObjectPathSafeMethod() =>
            MethodDeclaration(
                    PredefinedType(Token(SyntaxKind.VoidKeyword)),
                    "WriteObjectPathSafe")
                .AddModifiers(
                    Token(SyntaxKind.PublicKeyword),
                    Token(SyntaxKind.StaticKeyword))
                .AddParameterListParameters(
                    Parameter(
                            Identifier("writer"))
                        .WithType(
                            IdentifierName("Tmds.DBus.Protocol.MessageWriter"))
                        .AddModifiers(
                            Token(SyntaxKind.ThisKeyword),
                            Token(SyntaxKind.RefKeyword)),
                    Parameter(
                            Identifier("value"))
                        .WithType(
                            IdentifierName("Tmds.DBus.Protocol.ObjectPath")))
                .WithExpressionBody(
                    ArrowExpressionClause(
                        InvocationExpression(
                                MakeMemberAccessExpression("writer", "WriteObjectPath"))
                            .AddArgumentListArguments(
                                Argument(
                                    InvocationExpression(
                                        MakeMemberAccessExpression("value", "ToString"))))))
                .WithSemicolonToken(Token(SyntaxKind.SemicolonToken));

        private const string SignalHelperClass = """
                                                  // <auto-generated/>
                                                  using System;
                                                  using System.Threading.Tasks;
                                                  
                                                  #pragma warning disable
                                                  #nullable enable
                                                  namespace Tmds.DBus.SourceGenerator
                                                  {
                                                      internal static class SignalHelper
                                                      {
                                                          public static ValueTask<IDisposable> WatchSignalAsync(Tmds.DBus.Protocol.Connection connection, Tmds.DBus.Protocol.MatchRule rule, Action<Exception?> handler, bool emitOnCapturedContext = true, Tmds.DBus.Protocol.ObserverFlags flags = Tmds.DBus.Protocol.ObserverFlags.None)
                                                              => connection.AddMatchAsync(rule, static (_, _) => null !, static (Exception? e, object _, object? _, object? handlerState) => ((Action<Exception?>)handlerState!).Invoke(e), null, handler, emitOnCapturedContext, flags);
                                                  
                                                          public static ValueTask<IDisposable> WatchSignalAsync<T>(Tmds.DBus.Protocol.Connection connection, Tmds.DBus.Protocol.MatchRule rule, Tmds.DBus.Protocol.MessageValueReader<T> reader, Action<Exception?, T> handler, bool emitOnCapturedContext = true, Tmds.DBus.Protocol.ObserverFlags flags = Tmds.DBus.Protocol.ObserverFlags.None)
                                                              => connection.AddMatchAsync(rule, reader, static (e, arg, _, handlerState) => ((Action<Exception?, T>)handlerState!).Invoke(e, arg), null, handler, emitOnCapturedContext, flags);
                                                  
                                                          public static ValueTask<IDisposable> WatchPropertiesChangedAsync<T>(Tmds.DBus.Protocol.Connection connection, string destination, string path, string @interface, Tmds.DBus.Protocol.MessageValueReader<PropertyChanges<T>> reader, Action<Exception?, PropertyChanges<T>> handler, bool emitOnCapturedContext = true, Tmds.DBus.Protocol.ObserverFlags flags = Tmds.DBus.Protocol.ObserverFlags.None)
                                                          {
                                                              Tmds.DBus.Protocol.MatchRule rule = new()
                                                              {
                                                                  Type = Tmds.DBus.Protocol.MessageType.Signal,
                                                                  Sender = destination,
                                                                  Path = path,
                                                                  Member = "PropertiesChanged",
                                                                  Interface = "org.freedesktop.DBus.Properties",
                                                                  Arg0 = @interface
                                                              };
                                                  
                                                              return WatchSignalAsync(connection, rule, reader, handler, emitOnCapturedContext, flags);
                                                          }
                                                      }
                                                  }
                                                  """;

        private const string PropertyChangesClass = """
                                                     // <auto-generated/>
                                                     using System;
                                                     
                                                     #pragma warning disable
                                                     #nullable enable
                                                     namespace Tmds.DBus.SourceGenerator
                                                     {
                                                         internal record PropertyChanges<TProperties>(TProperties Properties, string[] Invalidated, string[] Changed)
                                                         {
                                                             public bool HasChanged(string property) => Array.IndexOf(Changed, property) != -1;
                                                             public bool IsInvalidated(string property) => Array.IndexOf(Invalidated, property) != -1;
                                                         }
                                                     }

                                                     """;

        private const string DBusInterfaceHandlerInterface = """
                                                              // <auto-generated/>
                                                              using System;
                                                              using System.Collections.Generic;
                                                              using System.Threading.Tasks;
                                                              
                                                              #pragma warning disable
                                                              #nullable enable
                                                              namespace Tmds.DBus.SourceGenerator
                                                              {
                                                                  internal interface IDBusInterfaceHandler
                                                                  {
                                                                      PathHandler? PathHandler { get; set; }
                                                                  
                                                                      Tmds.DBus.Protocol.Connection Connection { get; }
                                                              
                                                                      string InterfaceName { get; }
                                                              
                                                                      ReadOnlyMemory<byte> IntrospectXml { get; }
                                                              
                                                                      void ReplyGetProperty(string name, Tmds.DBus.Protocol.MethodContext context);

                                                                      Dictionary<string,Tmds.DBus.Protocol.Variant> GetAllProperties();
                                                              
                                                                      void ReplyGetAllProperties(Tmds.DBus.Protocol.MethodContext context);
                                                                      
                                                                      void SetProperty(string name, ref Tmds.DBus.Protocol.Reader reader);
                                                                      
                                                                      ValueTask ReplyInterfaceRequest(Tmds.DBus.Protocol.MethodContext context);
                                                                  }
                                                              }

                                                              """;

        private const string PathHandlerClass = """
                                                 // <auto-generated/>
                                                 using System.Collections.Generic;
                                                 using System.Linq;
                                                 using System.Threading.Tasks;

                                                 #pragma warning disable
                                                 #nullable enable
                                                 namespace Tmds.DBus.SourceGenerator
                                                 {
                                                     internal class PathHandler : Tmds.DBus.Protocol.IMethodHandler
                                                     {
                                                         private readonly bool _runMethodHandlerSynchronously;
                                                         private readonly ICollection<IDBusInterfaceHandler> _dbusInterfaces;
                                                 
                                                         public PathHandler(string path, bool runMethodHandlerSynchronously = true)
                                                         {
                                                             Path = path;
                                                             _runMethodHandlerSynchronously = runMethodHandlerSynchronously;
                                                             _dbusInterfaces = new List<IDBusInterfaceHandler>();
                                                         }
                                                 
                                                         /// <inheritdoc />
                                                         public string Path { get; }
                                                 
                                                         /// <inheritdoc />
                                                         public async ValueTask HandleMethodAsync(Tmds.DBus.Protocol.MethodContext context)
                                                         {
                                                             switch (context.Request.InterfaceAsString)
                                                             {
                                                                 case "org.freedesktop.DBus.Properties":
                                                                     switch (context.Request.MemberAsString, context.Request.SignatureAsString)
                                                                     {
                                                                         case ("Get", "ss"):
                                                                         {
                                                                             Reply();
                                                                             void Reply()
                                                                             {
                                                                                 Tmds.DBus.Protocol.Reader reader = context.Request.GetBodyReader();
                                                                                 string @interface = reader.ReadString();
                                                                                 IDBusInterfaceHandler? handler = _dbusInterfaces.FirstOrDefault(x => x.InterfaceName == @interface);
                                                                                 if (handler is null)
                                                                                     return;
                                                                                 string member = reader.ReadString();
                                                                                 handler.ReplyGetProperty(member, context);
                                                                             }
                                                 
                                                                             break;
                                                                         }
                                                                         case ("GetAll", "s"):
                                                                         {
                                                                             Reply();
                                                                             void Reply()
                                                                             {
                                                                                 Tmds.DBus.Protocol.Reader reader = context.Request.GetBodyReader();
                                                                                 string @interface = reader.ReadString();
                                                                                 IDBusInterfaceHandler? handler = _dbusInterfaces.FirstOrDefault(x => x.InterfaceName == @interface);
                                                                                 if (handler is null)
                                                                                     return;
                                                                                 handler.ReplyGetAllProperties(context);
                                                                             }
                                                 
                                                                             break;
                                                                         }
                                                                         case ("Set", "ssv"):
                                                                         {
                                                                             Reply();
                                                                             void Reply()
                                                                             {
                                                                                 Tmds.DBus.Protocol.Reader reader = context.Request.GetBodyReader();
                                                                                 string @interface = reader.ReadString();
                                                                                 IDBusInterfaceHandler? handler = _dbusInterfaces.FirstOrDefault(x => x.InterfaceName == @interface);
                                                                                 if (handler is null)
                                                                                     return;
                                                                                 string member = reader.ReadString();
                                                                                 handler.SetProperty(member, ref reader);
                                                                                 if (!context.NoReplyExpected)
                                                                                 {
                                                                                     using Tmds.DBus.Protocol.MessageWriter writer = context.CreateReplyWriter(null);
                                                                                     context.Reply(writer.CreateMessage());
                                                                                 }
                                                                             }
                                                                             
                                                                             break;
                                                                         }
                                                                     }
                                                 
                                                                     break;
                                                                 case "org.freedesktop.DBus.Introspectable":
                                                                     context.ReplyIntrospectXml(_dbusInterfaces.Select(static x => x.IntrospectXml).ToArray());
                                                                     break;
                                                                 default:
                                                                    IDBusInterfaceHandler? handler = _dbusInterfaces.FirstOrDefault(x => x.InterfaceName == context.Request.InterfaceAsString);
                                                                        if (handler is not null)
                                                                            await handler.ReplyInterfaceRequest(context);
                                                                    break;
                                                             }
                                                         }
                                                 
                                                         /// <inheritdoc />
                                                         public bool RunMethodHandlerSynchronously(Tmds.DBus.Protocol.Message message) => _runMethodHandlerSynchronously;
                                                 
                                                         /// <inheritdoc />
                                                         public void Add(IDBusInterfaceHandler item)
                                                         {
                                                             item.PathHandler = this;
                                                             _dbusInterfaces.Add(item);
                                                         }
                                                 
                                                         /// <inheritdoc />
                                                         public bool Contains(IDBusInterfaceHandler item) => _dbusInterfaces.Contains(item);
                                                 
                                                         /// <inheritdoc />
                                                         public bool Remove(IDBusInterfaceHandler item)
                                                         {
                                                             item.PathHandler = null;
                                                             return _dbusInterfaces.Remove(item);
                                                         }
                                                 
                                                         /// <inheritdoc />
                                                         public int Count => _dbusInterfaces.Count;

                                                         public IEnumerable<IDBusInterfaceHandler> DBusInterfaces => _dbusInterfaces;
                                                     }
                                                 }
                                                 """;
    }
}
